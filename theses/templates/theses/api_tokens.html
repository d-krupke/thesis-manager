{% extends 'base.html' %}

{% block title %}API Tokens - Thesis Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>API Tokens</h1>
    <div>
        <a href="{% url 'api-docs' %}" class="btn btn-outline-primary" target="_blank">API Documentation</a>
        <form method="post" action="{% url 'api_token_create' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">Create New Token</button>
        </form>
    </div>
</div>

<div class="alert alert-info">
    <h5>About API Tokens</h5>
    <p class="mb-0">
        API tokens allow you to authenticate with the Thesis Manager API without using your password.
        Each token is unique and can be used to make API requests. You can create up to 10 tokens.
        <strong>Important:</strong> Tokens are only shown once when created. Make sure to copy and save them securely.
    </p>
</div>

{% if request.session.new_api_token %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <h5>New Token Created!</h5>
    <p>Make sure to copy your new API token now. You won't be able to see it again!</p>
    <div class="input-group mb-3">
        <input type="text" class="form-control font-monospace" value="{{ request.session.new_api_token }}" id="newToken" readonly>
        <button class="btn btn-outline-secondary" type="button" onclick="copyToken()">Copy</button>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Your API Tokens</h5>
        {% if tokens %}
        <form method="post" action="{% url 'api_tokens_delete_all' %}" onsubmit="return confirm('Are you sure you want to delete all your API tokens? This action cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete All Tokens</button>
        </form>
        {% endif %}
    </div>
    <div class="card-body">
        {% if tokens %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Token Prefix</th>
                        <th>Created</th>
                        <th>Last Used</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for token in tokens %}
                    <tr>
                        <td><code>{{ token.token_key }}...</code></td>
                        <td>{{ token.created|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if token.expiry %}
                                {{ token.expiry|date:"Y-m-d H:i" }}
                            {% else %}
                                <span class="text-muted">Never expires</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" action="{% url 'api_token_delete' token.token_key %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this token?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">You don't have any API tokens yet. Create one to get started with the API.</p>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <h3>Quick Start</h3>
    <p>Once you have a token, you can use it to authenticate API requests:</p>

    <h5>Using curl:</h5>
    <pre class="bg-light p-3 rounded"><code>curl -H "Authorization: Token YOUR_TOKEN_HERE" {{ request.scheme }}://{{ request.get_host }}/api/theses/</code></pre>

    <h5>Using Python (requests library):</h5>
    <pre class="bg-light p-3 rounded"><code>import requests

headers = {
    'Authorization': 'Token YOUR_TOKEN_HERE'
}

response = requests.get('{{ request.scheme }}://{{ request.get_host }}/api/theses/', headers=headers)
data = response.json()</code></pre>

    <h5>Using JavaScript (fetch):</h5>
    <pre class="bg-light p-3 rounded"><code>fetch('{{ request.scheme }}://{{ request.get_host }}/api/theses/', {
    headers: {
        'Authorization': 'Token YOUR_TOKEN_HERE'
    }
})
.then(response => response.json())
.then(data => console.log(data));</code></pre>

    <p class="mt-3">
        For complete API documentation, visit the
        <a href="{% url 'api-docs' %}" target="_blank">API Documentation</a>.
    </p>
</div>

<script>
function copyToken() {
    const tokenInput = document.getElementById('newToken');
    tokenInput.select();
    tokenInput.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand('copy');

    // Change button text temporarily
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    setTimeout(() => {
        button.textContent = originalText;
    }, 2000);
}
</script>

{# Clear the session variable after displaying #}
{% if request.session.new_api_token %}
    {{ request.session.new_api_token|add:""|truncatewords:0 }}
    {% with request.session.pop as _ %}{% endwith %}
{% endif %}

{% endblock %}
