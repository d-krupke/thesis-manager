{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Thesis{% else %}New Thesis{% endif %} - Thesis Manager{% endblock %}

{% block content %}
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/select2-bootstrap-5-theme.min.css' %}" rel="stylesheet" />
<div class="row">
    <div class="col-lg-10 offset-lg-1">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{% if form.instance.pk %}Edit Thesis{% else %}Create New Thesis{% endif %}</h1>
            <a href="{% if form.instance.pk %}{% url 'thesis_detail' form.instance.pk %}{% else %}{% url 'thesis_list' %}{% endif %}" class="btn btn-outline-secondary">Cancel</a>
        </div>

        <form method="post" class="card">
            {% csrf_token %}
            <div class="card-body">
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="text-danger"><small>{{ form.title.errors }}</small></div>
                        {% endif %}
                        <small class="form-text text-muted">{{ form.title.help_text }}</small>
                    </div>
                    <div class="col-md-2">
                        <label for="{{ form.thesis_type.id_for_label }}" class="form-label">{{ form.thesis_type.label }}</label>
                        {{ form.thesis_type }}
                        {% if form.thesis_type.errors %}
                        <div class="text-danger"><small>{{ form.thesis_type.errors }}</small></div>
                        {% endif %}
                    </div>
                    <div class="col-md-2">
                        <label for="{{ form.phase.id_for_label }}" class="form-label">{{ form.phase.label }}</label>
                        {{ form.phase }}
                        {% if form.phase.errors %}
                        <div class="text-danger"><small>{{ form.phase.errors }}</small></div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.students.id_for_label }}" class="form-label">{{ form.students.label }} <span class="text-muted">(optional)</span></label>
                        {{ form.students }}
                        {% if form.students.errors %}
                        <div class="text-danger"><small>{{ form.students.errors }}</small></div>
                        {% endif %}
                        <small class="form-text text-muted">Type to search and select students. Can be added later.</small>
                        <div class="mt-1">
                            <a href="{% url 'student_create' %}" class="btn btn-sm btn-outline-secondary" target="_blank">+ New Student</a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.supervisors.id_for_label }}" class="form-label">{{ form.supervisors.label }} <span class="text-muted">(optional)</span></label>
                        {{ form.supervisors }}
                        {% if form.supervisors.errors %}
                        <div class="text-danger"><small>{{ form.supervisors.errors }}</small></div>
                        {% endif %}
                        <small class="form-text text-muted">Type to search and select supervisors. Can be added later.</small>
                        <div class="mt-1">
                            <a href="{% url 'supervisor_create' %}" class="btn btn-sm btn-outline-secondary" target="_blank">+ New Supervisor</a>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="mb-3">Timeline</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.date_first_contact.id_for_label }}" class="form-label">{{ form.date_first_contact.label }}</label>
                        {{ form.date_first_contact }}
                        {% if form.date_first_contact.errors %}
                        <div class="text-danger"><small>{{ form.date_first_contact.errors }}</small></div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.date_topic_selected.id_for_label }}" class="form-label">{{ form.date_topic_selected.label }}</label>
                        {{ form.date_topic_selected }}
                        {% if form.date_topic_selected.errors %}
                        <div class="text-danger"><small>{{ form.date_topic_selected.errors }}</small></div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.date_registration.id_for_label }}" class="form-label">{{ form.date_registration.label }}</label>
                        {{ form.date_registration }}
                        {% if form.date_registration.errors %}
                        <div class="text-danger"><small>{{ form.date_registration.errors }}</small></div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.date_deadline.id_for_label }}" class="form-label">{{ form.date_deadline.label }}</label>
                        {{ form.date_deadline }}
                        {% if form.date_deadline.errors %}
                        <div class="text-danger"><small>{{ form.date_deadline.errors }}</small></div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.date_presentation.id_for_label }}" class="form-label">{{ form.date_presentation.label }}</label>
                        {{ form.date_presentation }}
                        {% if form.date_presentation.errors %}
                        <div class="text-danger"><small>{{ form.date_presentation.errors }}</small></div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.date_review.id_for_label }}" class="form-label">{{ form.date_review.label }}</label>
                        {{ form.date_review }}
                        {% if form.date_review.errors %}
                        <div class="text-danger"><small>{{ form.date_review.errors }}</small></div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.date_final_discussion.id_for_label }}" class="form-label">{{ form.date_final_discussion.label }}</label>
                        {{ form.date_final_discussion }}
                        {% if form.date_final_discussion.errors %}
                        <div class="text-danger"><small>{{ form.date_final_discussion.errors }}</small></div>
                        {% endif %}
                    </div>
                </div>

                <hr class="my-4">

                <div class="mb-3">
                    <label for="{{ form.git_repository.id_for_label }}" class="form-label">{{ form.git_repository.label }}</label>
                    {{ form.git_repository }}
                    {% if form.git_repository.errors %}
                    <div class="text-danger"><small>{{ form.git_repository.errors }}</small></div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.git_repository.help_text }}</small>
                </div>

                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="text-danger"><small>{{ form.description.errors }}</small></div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.description.help_text }}</small>
                </div>

                <hr class="my-4">
                <h5 class="mb-3">Formal Documents</h5>

                <div class="mb-3">
                    <label for="{{ form.task_description.id_for_label }}" class="form-label">
                        <i class="bi bi-file-text"></i> {{ form.task_description.label }}
                    </label>
                    {{ form.task_description }}
                    {% if form.task_description.errors %}
                    <div class="text-danger"><small>{{ form.task_description.errors }}</small></div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.task_description.help_text }}</small>
                </div>

                <div class="mb-3">
                    <label for="{{ form.review.id_for_label }}" class="form-label">
                        <i class="bi bi-file-earmark-check"></i> {{ form.review.label }}
                    </label>
                    {{ form.review }}
                    {% if form.review.errors %}
                    <div class="text-danger"><small>{{ form.review.errors }}</small></div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.review.help_text }}</small>
                </div>

                <hr class="my-4">
                <h5 class="mb-3">AI-Enhanced Reporting Settings</h5>
                <p class="text-muted small">Configure AI-powered progress analysis for weekly reports. Disable if student does not consent to external AI processing.</p>

                <div class="mb-3">
                    <div class="form-check">
                        {{ form.ai_summary_enabled }}
                        <label class="form-check-label" for="{{ form.ai_summary_enabled.id_for_label }}">
                            {{ form.ai_summary_enabled.label }}
                        </label>
                    </div>
                    {% if form.ai_summary_enabled.errors %}
                    <div class="text-danger"><small>{{ form.ai_summary_enabled.errors }}</small></div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.ai_summary_enabled.help_text }}</small>
                </div>

                <div class="mb-3">
                    <label for="{{ form.ai_context.id_for_label }}" class="form-label">{{ form.ai_context.label }}</label>
                    {{ form.ai_context }}
                    {% if form.ai_context.errors %}
                    <div class="text-danger"><small>{{ form.ai_context.errors }}</small></div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.ai_context.help_text }}</small>
                </div>
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="{% if form.instance.pk %}{% url 'thesis_detail' form.instance.pk %}{% else %}{% url 'thesis_list' %}{% endif %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/select2.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Initialize Select2 for students and supervisors fields with Bootstrap 5 theme
    $('#{{ form.students.id_for_label }}, #{{ form.supervisors.id_for_label }}').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Select or search...',
        allowClear: true,
        closeOnSelect: false  // Keep dropdown open when selecting multiple items
    });
});
</script>
{% endblock %}
